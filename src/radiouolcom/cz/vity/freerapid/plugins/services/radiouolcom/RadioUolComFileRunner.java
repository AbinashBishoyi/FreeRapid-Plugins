package cz.vity.freerapid.plugins.services.radiouolcom;

import cz.vity.freerapid.plugins.exceptions.*;
import cz.vity.freerapid.plugins.services.rtmp.AbstractRtmpRunner;
import cz.vity.freerapid.plugins.services.rtmp.RtmpSession;
import cz.vity.freerapid.plugins.services.rtmp.SwfVerificationHelper;
import cz.vity.freerapid.plugins.webclient.FileState;
import org.apache.commons.httpclient.HttpMethod;

import java.util.logging.Logger;
import java.util.regex.Matcher;

/**
 * Class which contains main code
 *
 * @author tong2shot
 * @since 0.9u2
 */
class RadioUolComFileRunner extends AbstractRtmpRunner {
    private final static Logger logger = Logger.getLogger(RadioUolComFileRunner.class.getName());
    private final static int MAX_HASH = 0x80000;
    private final static int MAX_RANDOM_TAB = 0x1f;
    private final static int[][] vHash = {{95654, 143678, 448668, 188980, 347121, 338744, 171459, 219257, 224951, 508917, 2998, 339195, 270875, 49028, 144329, 436890, 109211, 94321, 510535, 21757, 343781, 443076, 130903, 266964, 108309, 288520, 189734, 155221, 286630, 74790, 85682, 270265}, {299117, 483578, 273545, 163720, 188903, 16463, 313021, 256141, 406834, 144438, 380273, 432950, 490743, 374640, 332600, 368191, 159647, 255425, 450225, 295527, 99613, 194051, 268949, 88332, 109723, 271037, 17819, 157562, 352359, 350235, 56696, 428729}, {473179, 460813, 399947, 256435, 120099, 249695, 272845, 32118, 391335, 270495, 308110, 205164, 514540, 258972, 149896, 149335, 146620, 229967, 164465, 464093, 36704, 419327, 513273, 39544, 84683, 389489, 124263, 195988, 461679, 290541, 118986, 121273}, {86817, 455413, 6938, 247420, 368208, 179827, 212891, 449052, 422117, 111918, 31948, 207500, 14612, 472931, 282424, 47300, 221309, 243514, 338027, 121883, 499159, 109832, 84343, 142740, 430991, 136967, 16950, 269514, 197011, 97147, 94388, 311918}, {412326, 28151, 194056, 405009, 509842, 254621, 520166, 284431, 23665, 140333, 90180, 626, 65153, 68523, 198237, 350609, 283304, 74351, 296544, 104262, 149283, 500084, 497438, 269189, 33933, 445100, 362252, 220969, 248995, 58161, 82906, 371640}, {317200, 401188, 469505, 9484, 456327, 72188, 80778, 302219, 510608, 47, 325480, 511969, 359488, 153829, 517291, 401140, 294463, 288930, 65255, 290539, 426592, 94119, 494357, 383517, 151843, 364760, 226889, 325292, 485738, 456709, 14714, 59300}, {51386, 254037, 88011, 202354, 521800, 26039, 452221, 154741, 288059, 235023, 75780, 233096, 228440, 459017, 269676, 378444, 199546, 462675, 461683, 159492, 176418, 308238, 19103, 394709, 44137, 169294, 218021, 436021, 250284, 37492, 381806, 60772}, {447036, 39216, 44036, 150959, 49512, 459775, 205261, 134235, 244521, 476917, 69182, 461055, 314058, 227741, 52102, 69412, 502223, 153291, 173649, 245, 371066, 234782, 130327, 138193, 70451, 394520, 511541, 311443, 362021, 371592, 479271, 37720}, {152167, 137505, 477481, 159901, 363506, 428560, 406946, 434040, 362953, 385617, 255639, 185033, 180113, 288174, 72569, 390447, 350699, 5149, 308392, 157065, 49136, 449881, 423412, 13279, 202252, 485517, 60006, 71804, 6287, 390868, 447666, 477449}, {335430, 192867, 307595, 194941, 511341, 261679, 273218, 16558, 132934, 196574, 391145, 16978, 247969, 12245, 423262, 322122, 473014, 363302, 159865, 405239, 250249, 136520, 253637, 178807, 238396, 195916, 125951, 263314, 46490, 490613, 300725, 479529}, {84766, 151286, 143705, 110843, 477914, 61867, 292615, 330890, 142466, 350626, 228713, 486128, 193515, 173106, 435944, 266365, 476243, 18574, 447134, 506593, 216513, 105856, 90421, 404156, 151748, 69695, 81952, 480352, 175860, 471826, 132722, 392084}, {325743, 382119, 84122, 10284, 336051, 432863, 238186, 248643, 130843, 206313, 364708, 464612, 96598, 166515, 265574, 291834, 471070, 326597, 392396, 371794, 16528, 182432, 381191, 51322, 42589, 481178, 157510, 215900, 394561, 235996, 456898, 384849}, {6641, 357644, 267569, 209553, 52460, 192302, 456188, 43706, 318314, 29006, 70530, 442711, 148677, 81868, 507838, 83228, 205997, 20744, 172947, 353725, 154727, 390481, 22042, 285222, 223101, 281818, 122694, 367332, 520738, 86669, 53531, 201873}, {278937, 85125, 507097, 286739, 473332, 507140, 140134, 260219, 245375, 489651, 498247, 168031, 491542, 282879, 374899, 70249, 429776, 117595, 358490, 99075, 263218, 174147, 202342, 123617, 384338, 296647, 200015, 154691, 356913, 113515, 240523, 93871}, {420242, 97085, 55080, 358150, 246708, 247258, 454512, 187323, 364582, 197445, 152974, 85754, 138528, 70741, 196511, 66192, 190610, 40589, 430948, 152427, 21846, 370229, 516092, 482421, 467141, 136051, 10218, 461484, 511745, 231749, 362169, 308782}, {179781, 524072, 120717, 388648, 215948, 383026, 449526, 135000, 93414, 179322, 457806, 288528, 221107, 148385, 382201, 134763, 33589, 166200, 56783, 21417, 209331, 69101, 447241, 487766, 91257, 381498, 270587, 490811, 207137, 352628, 224746, 189118}, {157777, 298500, 227155, 157345, 79963, 125333, 446964, 170972, 192509, 101908, 439767, 121715, 26522, 497219, 514512, 15102, 86330, 306879, 490385, 42969, 215457, 422458, 461780, 210594, 212682, 183745, 430015, 319737, 459288, 160731, 41721, 21815}, {218772, 159578, 466846, 402946, 427383, 12443, 314234, 37243, 32101, 391708, 459732, 16864, 506522, 482082, 146189, 250743, 372823, 422224, 341371, 234883, 402934, 193528, 85179, 386594, 193487, 235000, 105165, 438998, 50793, 70886, 510045, 397724}, {133153, 22138, 217962, 430153, 183215, 409315, 490936, 246288, 232403, 292072, 306248, 310524, 52850, 135855, 252724, 303916, 209792, 412640, 385848, 327063, 406012, 351243, 305208, 170054, 245592, 104984, 123414, 375215, 22415, 219021, 396070, 129306}, {349767, 146563, 137617, 41433, 478031, 138005, 755, 162595, 192179, 245527, 41874, 194138, 365275, 2280, 97378, 470943, 355551, 44082, 120140, 448112, 181630, 406882, 338657, 261676, 335601, 426662, 26855, 65608, 431616, 108369, 19712, 66566}, {278161, 342618, 91843, 27012, 259610, 482022, 361613, 409573, 466989, 212880, 456297, 465010, 392072, 61265, 518736, 258684, 47068, 52433, 212759, 370131, 143035, 124660, 296291, 400282, 269278, 494448, 425955, 315216, 387884, 483900, 151086, 228322}, {371905, 352942, 362380, 164483, 424271, 408851, 189697, 164658, 35620, 220551, 504802, 116905, 363045, 358139, 9294, 37786, 459542, 233234, 368849, 457455, 375918, 314821, 308870, 131327, 431389, 187788, 241419, 239458, 316285, 94948, 513935, 210264}, {148692, 367612, 363091, 495226, 214951, 312163, 420323, 352654, 513330, 514681, 120679, 401742, 186459, 191104, 362312, 205558, 432744, 283925, 471436, 125021, 509903, 87777, 308524, 230773, 35175, 452957, 368567, 80640, 157783, 453223, 517276, 248381}, {11522, 96902, 108886, 110455, 41812, 117928, 222691, 154408, 10413, 273452, 12991, 109464, 74185, 51204, 391108, 479931, 192742, 252866, 280887, 97823, 245387, 6494, 465488, 65730, 221488, 245903, 132763, 485528, 322071, 236143, 118119, 316303}, {55227, 72282, 242865, 262641, 239618, 143037, 385738, 462298, 229030, 120497, 22539, 416171, 249354, 23349, 265185, 373053, 486109, 70861, 314006, 82850, 11469, 127069, 183051, 329043, 473250, 421910, 167364, 341120, 150039, 306990, 290972, 402296}, {52651, 457042, 97366, 267979, 480472, 512137, 19323, 126759, 59621, 50787, 230340, 426131, 260788, 415563, 210265, 320248, 272343, 262322, 232780, 242110, 182071, 267529, 369290, 137791, 403878, 416308, 179866, 508668, 177319, 477538, 482691, 393033}, {96183, 512271, 80403, 355665, 366198, 181241, 202227, 198204, 318446, 109031, 100031, 184901, 1365, 422151, 387967, 318614, 314517, 166074, 509907, 175282, 423144, 407701, 72728, 30026, 103900, 299121, 519134, 348725, 334612, 71762, 392700, 88447}, {321790, 291070, 523153, 453943, 151799, 286729, 421193, 435695, 227583, 150570, 372778, 153506, 333175, 63670, 382273, 269542, 85267, 481525, 31104, 130603, 219510, 171585, 64794, 373982, 94367, 339361, 203691, 144449, 376227, 193486, 311425, 396225}, {239834, 366677, 134225, 155807, 27118, 285370, 383918, 140995, 317456, 257639, 374670, 289397, 173723, 160814, 389926, 452326, 46729, 178751, 119937, 249660, 57075, 13652, 261901, 432660, 362755, 176098, 323958, 510240, 439700, 357937, 16934, 463071}, {294108, 118804, 352174, 388626, 53867, 516892, 390253, 172258, 217554, 238111, 173772, 307059, 4672, 342222, 444752, 31674, 391524, 355389, 305120, 467557, 114666, 439073, 424329, 180905, 54230, 217756, 235535, 358587, 163618, 497249, 424092, 179924}, {406228, 345348, 391903, 496259, 233718, 179012, 261612, 370208, 248242, 303903, 246818, 69688, 268764, 329089, 297339, 414897, 439121, 360286, 510335, 19855, 135521, 306437, 461889, 156425, 439715, 26753, 175007, 240869, 33664, 475597, 121897, 196805}, {223943, 238012, 286451, 170833, 183186, 152150, 498600, 261119, 522195, 307583, 228389, 111950, 422112, 302267, 474363, 351559, 260403, 339675, 229403, 226315, 478423, 504423, 346368, 393288, 150698, 505227, 336809, 52060, 238300, 259692, 430512, 495872}, {24823, 256152, 389845, 467012, 512441, 188027, 423995, 415141, 176920, 158622, 412613, 196647, 214710, 351865, 323265, 77086, 336168, 244408, 453963, 65688, 154182, 419510, 155053, 10787, 506601, 444674, 81162, 12230, 179806, 220355, 103599, 144126}, {178143, 413121, 486727, 228749, 140900, 423658, 126809, 265703, 408344, 370728, 240206, 99615, 53444, 57924, 382294, 344580, 298121, 16834, 489343, 270172, 236065, 301933, 245319, 79107, 487447, 22388, 418811, 206262, 213544, 516574, 123195, 322914}, {213557, 266537, 81640, 511432, 35331, 404963, 440270, 254274, 295463, 118801, 62306, 1405, 447593, 299310, 163038, 14832, 422375, 433040, 144387, 210920, 61270, 92689, 511720, 324602, 226212, 234684, 335371, 254631, 372566, 86357, 237062, 148471}, {117991, 88204, 392239, 222203, 263295, 338606, 429441, 436189, 96084, 145560, 413953, 485746, 12542, 475090, 258325, 68868, 108303, 406146, 479483, 157494, 379211, 478768, 298437, 160453, 437947, 364029, 62503, 163837, 271870, 487240, 345688, 487861}, {190750, 67953, 182127, 279958, 323390, 377759, 252788, 266120, 479334, 32070, 370051, 47638, 420309, 51286, 386901, 411532, 158471, 187846, 491365, 522668, 339427, 409442, 15660, 372680, 407104, 295845, 285844, 259337, 192303, 430690, 447513, 41660}, {505407, 172840, 113363, 42098, 130845, 38931, 484801, 87487, 316383, 317934, 226714, 72560, 471099, 238699, 190605, 476157, 471055, 506703, 220444, 189720, 377720, 510795, 265604, 218644, 300243, 344939, 435440, 200963, 198388, 409048, 190916, 470615}, {502757, 137419, 414305, 153813, 85622, 371315, 521117, 131496, 369402, 33963, 119379, 509548, 257400, 34635, 162634, 484599, 484769, 264669, 319185, 213684, 514784, 339862, 51025, 423780, 464075, 164433, 252982, 226576, 435793, 113514, 130165, 119035}, {287720, 109375, 251384, 285546, 223002, 490031, 260440, 171536, 295852, 133094, 344851, 393956, 216268, 260024, 85426, 216899, 279154, 131833, 178705, 313634, 358763, 488442, 357676, 17947, 330300, 407204, 441528, 429628, 511299, 177504, 490971, 452165}, {484442, 377648, 377683, 147275, 19542, 7619, 344666, 357234, 502439, 236622, 241563, 74138, 312690, 387587, 221059, 9174, 233071, 505078, 380739, 214639, 287458, 99384, 3534, 118600, 72947, 324088, 300581, 167806, 52418, 381069, 67142, 41727}, {125317, 183065, 145413, 109561, 427248, 23733, 432935, 82416, 460114, 230110, 346629, 423482, 402591, 219650, 11288, 309708, 289985, 122099, 37801, 72209, 140168, 281113, 7685, 504995, 299637, 211758, 210818, 224185, 446657, 83534, 491162, 216859}, {438255, 330042, 416636, 382817, 271658, 51604, 228187, 129879, 295891, 417500, 489670, 86362, 202626, 124183, 54372, 317550, 402890, 49365, 31580, 503530, 137755, 313203, 225980, 517773, 301059, 321647, 55602, 380855, 420395, 360074, 150104, 360374}, {376406, 162209, 313600, 327639, 121020, 318457, 110510, 228639, 418566, 233429, 114859, 195195, 439620, 353326, 18676, 422188, 61734, 461134, 90961, 128325, 360914, 274468, 312055, 89619, 101529, 424239, 394991, 269358, 137446, 502194, 291228, 151831}, {143284, 436259, 391603, 517659, 519388, 2695, 328689, 412265, 226948, 232355, 306910, 305672, 461064, 492990, 357360, 55715, 49068, 170969, 195415, 56534, 359519, 132116, 285140, 382699, 19179, 28715, 100816, 352190, 185809, 416450, 248601, 368813}, {130364, 35425, 175759, 214873, 350776, 320750, 322830, 411135, 94877, 14440, 180960, 230228, 170986, 92102, 484121, 394648, 132458, 488636, 12312, 118461, 465901, 10551, 180363, 362869, 357223, 306540, 414274, 413934, 171208, 8509, 140830, 149269}, {510044, 154053, 23148, 218914, 52985, 404963, 275211, 224343, 341598, 476817, 219278, 429726, 524034, 471505, 225740, 377082, 33708, 295173, 38165, 468865, 93473, 66951, 354414, 320699, 177718, 378947, 221713, 280628, 63134, 271156, 29843, 152081}, {435386, 224642, 494585, 80246, 243904, 128296, 170759, 298384, 333196, 428757, 496158, 439054, 480609, 372465, 357117, 190948, 4854, 161935, 249516, 176406, 360731, 497932, 349417, 280689, 400699, 26956, 374366, 145900, 99104, 309054, 259324, 81553}, {516663, 267416, 284608, 163004, 478891, 438666, 37178, 264051, 336551, 153652, 82464, 45239, 384529, 124870, 121660, 174745, 486662, 309243, 457748, 138458, 30580, 104407, 509314, 114422, 218643, 435308, 274855, 503901, 295703, 261759, 351348, 12974}, {186096, 225231, 49700, 168902, 236368, 154332, 316153, 425843, 358633, 383482, 251262, 72341, 228887, 179319, 125619, 373638, 325332, 268984, 270684, 359825, 493632, 230401, 57305, 309073, 457747, 348884, 361924, 116153, 90693, 163493, 131250, 276394}, {436536, 478136, 76132, 413648, 34494, 230399, 268463, 236718, 165445, 355770, 474494, 151695, 150131, 294583, 120613, 226627, 363154, 251133, 233841, 508271, 396812, 444336, 22953, 245557, 254542, 224509, 7654, 400924, 213349, 506853, 459272, 422897}, {399775, 391857, 176023, 88704, 57474, 292061, 180197, 49642, 480617, 195924, 317884, 293236, 4637, 428992, 62960, 481938, 344493, 19915, 481302, 76812, 364511, 118545, 8900, 277757, 155021, 222378, 264343, 516490, 491566, 316161, 423262, 419099}, {347374, 143070, 238766, 372709, 485790, 17512, 30010, 378776, 120764, 284912, 418354, 490751, 124936, 190042, 255499, 607, 147146, 522476, 41963, 249967, 510780, 139870, 331546, 272816, 101973, 425706, 451006, 439795, 411470, 70468, 429626, 399847}, {103977, 54321, 389239, 333945, 384657, 127647, 384618, 243156, 77665, 233730, 446770, 458196, 109857, 512212, 47624, 31166, 96202, 405751, 471144, 133894, 179740, 32728, 98482, 379646, 174821, 142868, 113818, 506160, 332401, 39043, 182459, 27713}, {213133, 60004, 228501, 303905, 393556, 361096, 279626, 360035, 391475, 86085, 347495, 21378, 367183, 222984, 336402, 226800, 360390, 4427, 176097, 457642, 438519, 456140, 135598, 355649, 411958, 486346, 69059, 31493, 211515, 320797, 463768, 80701}, {88464, 351995, 302730, 139049, 303962, 201781, 474313, 177843, 300743, 79296, 136153, 164994, 117363, 79961, 431600, 36445, 479508, 217104, 406913, 65437, 409786, 64657, 278091, 73085, 239865, 267000, 431405, 259871, 32328, 490491, 326181, 501017}, {490212, 59204, 33200, 235083, 438158, 261826, 21745, 283102, 96365, 11973, 352744, 16436, 246888, 123319, 294655, 226971, 71489, 464955, 368464, 404366, 26832, 364679, 462558, 156512, 130461, 408019, 346150, 102166, 364337, 424591, 183886, 147775}, {365684, 252503, 495929, 50855, 13399, 125524, 309987, 219815, 485167, 315630, 24397, 252135, 1282, 305049, 287291, 342117, 194837, 451463, 327726, 181649, 298268, 216089, 377303, 129858, 243783, 101339, 473941, 394346, 432264, 209623, 316057, 350785}, {112229, 264983, 516659, 433354, 355733, 518682, 321502, 109947, 511697, 111648, 2078, 343503, 100625, 200705, 2614, 486821, 123539, 480381, 133591, 114473, 33788, 426427, 292289, 364582, 250328, 435162, 363707, 422535, 510681, 181594, 25640, 206811}, {252694, 434735, 236935, 306602, 380579, 366159, 412216, 307826, 329680, 117897, 136904, 128271, 218973, 425083, 373022, 96875, 20215, 331886, 489183, 470848, 41030, 87531, 447295, 488887, 333035, 288227, 150963, 346307, 255402, 47913, 74932, 395508}, {241953, 260119, 92663, 307366, 68694, 271925, 454499, 137035, 434532, 443554, 257555, 464303, 264874, 508957, 142011, 509683, 70326, 366964, 160949, 314411, 113485, 383282, 46864, 25164, 223188, 219477, 290035, 83036, 311674, 237534, 9362, 310684}, {25945, 356110, 448029, 260487, 403195, 363034, 208360, 428403, 502655, 87855, 230179, 344484, 220084, 52615, 331374, 326051, 271746, 141430, 134561, 26025, 343771, 139811, 56332, 207076, 464547, 197335, 368778, 420477, 383428, 236447, 330929, 41231}, {158923, 347422, 311920, 455299, 291931, 361814, 348014, 421887, 458956, 239930, 149363, 434125, 109363, 10467, 450867, 340235, 355395, 296738, 37575, 286434, 470838, 419674, 361764, 160555, 138527, 81498, 151520, 66104, 55035, 199963, 84120, 385969}, {478909, 38428, 379712, 431671, 436665, 313417, 473779, 42412, 102576, 369693, 135897, 447985, 101335, 436709, 81823, 212451, 361247, 387570, 460323, 141419, 406813, 334205, 206693, 31603, 487628, 235803, 228795, 167563, 268430, 74634, 340076, 378129}, {487090, 189862, 438966, 518571, 517585, 395872, 400785, 209638, 436556, 216950, 265607, 328388, 216138, 459210, 67553, 515343, 296820, 510504, 165004, 440894, 370635, 326973, 332788, 50875, 281318, 175007, 176694, 51293, 212708, 424112, 471784, 183782}, {382565, 280868, 51926, 357968, 178905, 336912, 5882, 133055, 409978, 338737, 104966, 505826, 164147, 481628, 164804, 192926, 451033, 442323, 241587, 69060, 104178, 345429, 8722, 253611, 225892, 488374, 517321, 432255, 111967, 240345, 327523, 461332}, {131017, 72137, 417662, 181251, 145538, 10456, 254204, 505331, 82636, 166274, 474938, 193488, 364335, 322283, 496299, 442055, 266273, 482249, 6178, 169933, 316607, 240776, 481561, 330645, 165366, 175738, 91718, 463278, 474203, 128733, 438221, 279207}, {237328, 251536, 73830, 119561, 325110, 164162, 162493, 10986, 250769, 387305, 103010, 7168, 472281, 105556, 512915, 336362, 487256, 328107, 370495, 115348, 65499, 298918, 170621, 134774, 83463, 406094, 379607, 158350, 422703, 381469, 258737, 407511}, {27809, 65088, 166688, 169490, 138201, 132322, 184959, 354741, 106704, 216622, 270614, 521932, 136386, 235773, 184084, 445589, 198084, 180709, 2376, 419773, 36198, 329606, 478156, 318194, 188092, 18656, 513026, 325550, 352809, 230531, 210227, 449282}, {257824, 321898, 414998, 289848, 28235, 398420, 487325, 410896, 272458, 40547, 154440, 435575, 409464, 453589, 270687, 294524, 281830, 406444, 5974, 19033, 185084, 459532, 196781, 479580, 78324, 67880, 285351, 9608, 1172, 377476, 183570, 297141}, {83307, 238694, 447888, 105215, 480995, 45889, 400523, 465247, 197245, 522470, 163141, 106033, 48513, 72023, 107585, 147328, 195447, 282367, 344412, 495839, 135346, 483620, 9444, 63660, 139590, 110952, 145661, 356992, 316084, 411424, 271015, 148131}, {454807, 182618, 225197, 313428, 126643, 107097, 102617, 296625, 404636, 266589, 162226, 501266, 334175, 440711, 235805, 301481, 118636, 18088, 63526, 474930, 228120, 395972, 304715, 440454, 448519, 393514, 275610, 223458, 216006, 28127, 56036, 125356}, {302584, 350772, 64614, 29840, 264265, 227673, 334639, 10943, 152217, 428473, 451473, 183067, 59788, 201203, 447221, 512811, 88050, 287289, 268124, 110751, 83255, 3308, 171738, 299834, 333121, 496454, 321642, 301286, 294915, 380117, 131414, 30679}, {192791, 105132, 275600, 29813, 80299, 180485, 150354, 482030, 465180, 19508, 251964, 286266, 88702, 110514, 57442, 75876, 311155, 317456, 413565, 463326, 436883, 242344, 196255, 90046, 161213, 210907, 306868, 37550, 367261, 315038, 78370, 277080}, {347578, 59972, 400089, 355118, 386648, 462125, 39965, 253513, 485257, 255316, 518502, 191813, 178338, 131431, 406935, 132572, 38288, 304980, 495590, 383758, 391465, 433932, 144838, 295861, 114171, 20049, 101146, 450628, 289727, 85090, 246794, 330635}, {369119, 106056, 157127, 148561, 149837, 399020, 466312, 436103, 242174, 122343, 67358, 146684, 129635, 323902, 153185, 344644, 235813, 291318, 225482, 346556, 39793, 386870, 450194, 372076, 140341, 139103, 70807, 262046, 389776, 468945, 520809, 429303}, {143297, 187343, 518589, 241117, 491260, 54627, 7844, 298763, 410450, 464134, 223693, 344842, 18979, 294636, 131113, 415864, 98888, 218802, 433465, 121563, 74331, 11342, 157537, 429527, 39520, 210688, 286592, 23708, 452398, 451878, 263986, 287052}, {350162, 160186, 197367, 102974, 429908, 170561, 448412, 330974, 100120, 334355, 162868, 139266, 36927, 350641, 480239, 172413, 511051, 117517, 408859, 246986, 479059, 112007, 244907, 430744, 202795, 179836, 386948, 84743, 410805, 279847, 492788, 26213}, {484032, 307889, 130954, 168518, 96190, 141629, 463797, 193207, 21402, 296635, 247153, 6499, 457998, 162392, 80, 298627, 294838, 423254, 89907, 487763, 400959, 166430, 258818, 40952, 386303, 251494, 96686, 262289, 119608, 450337, 413913, 192326}, {150386, 413481, 231782, 98100, 406812, 316249, 449357, 468468, 13279, 88310, 250616, 496534, 168673, 179509, 355200, 58083, 457806, 329381, 287518, 522151, 249727, 428889, 323859, 183020, 188925, 454809, 400991, 167641, 307653, 309999, 384161, 327199}, {493832, 12129, 462934, 316591, 249291, 233631, 138719, 350622, 373158, 85251, 336539, 265197, 45058, 31781, 449872, 388642, 181009, 464096, 418643, 235109, 258538, 495241, 137635, 4881, 185347, 338491, 131926, 187750, 516196, 453364, 282795, 294471}, {514270, 347489, 472060, 13002, 88992, 137766, 23549, 182377, 171881, 276334, 68740, 4773, 170167, 206993, 370985, 312812, 278583, 455858, 40738, 142739, 224470, 96008, 193938, 269488, 44456, 370107, 26026, 500649, 313878, 9755, 112108, 163393}, {329865, 167675, 404951, 514047, 464365, 1038, 282964, 454321, 418396, 417546, 175415, 214242, 327998, 189802, 219150, 294937, 496947, 299923, 517303, 374946, 428559, 20538, 515547, 60091, 448828, 320724, 97228, 221950, 118489, 352733, 204789, 223674}, {376793, 40907, 277310, 400181, 88956, 251774, 368300, 410749, 15467, 317176, 249746, 149175, 104401, 401708, 119454, 486572, 90801, 283076, 523029, 313452, 65501, 26510, 42385, 432334, 426697, 402057, 286599, 352425, 52641, 27706, 513776, 82825}, {215766, 510776, 1891, 189885, 375953, 11436, 291812, 456576, 235072, 252063, 251598, 48413, 167586, 77790, 363278, 151503, 103062, 515152, 68636, 458038, 523008, 26237, 345058, 333103, 57877, 437543, 194560, 40922, 503390, 296381, 33187, 516014}, {91076, 382577, 70994, 339278, 132330, 181460, 473593, 501011, 411963, 466354, 43132, 346104, 9695, 517392, 108338, 367576, 8708, 67341, 462469, 229552, 403638, 355464, 32280, 514766, 165022, 213063, 517047, 318380, 191484, 326523, 20331, 204115}, {523551, 383601, 272881, 421390, 345537, 369726, 146687, 5180, 59768, 277039, 104075, 490520, 13741, 77274, 404085, 43847, 256851, 435866, 208866, 98290, 114866, 76093, 299410, 240453, 38813, 483018, 418438, 98592, 138844, 377107, 8769, 467150}, {461728, 138749, 112128, 9355, 188359, 142396, 87589, 257962, 69581, 456283, 280894, 515380, 505903, 305890, 8155, 457414, 225305, 223839, 474784, 173439, 298789, 128562, 122319, 411864, 12804, 437468, 278431, 174372, 427102, 395950, 243896, 167325}, {282679, 520098, 409623, 214972, 494889, 406824, 234933, 491446, 369609, 501960, 239928, 120815, 414591, 150101, 246789, 484135, 500515, 439953, 201734, 496452, 392887, 323847, 495203, 12406, 499328, 18930, 375695, 4752, 232921, 321279, 55292, 180328}, {205326, 360376, 315052, 115458, 27533, 206953, 60689, 418915, 337335, 233552, 51569, 506836, 254898, 254444, 44845, 349033, 45690, 491053, 261685, 416920, 467597, 136551, 410878, 21430, 107896, 273101, 226879, 400421, 91551, 514372, 30164, 133379}, {407693, 113250, 217612, 127019, 263700, 465517, 121015, 282463, 391321, 470552, 381247, 46427, 1238, 51432, 524069, 264883, 315744, 72953, 404008, 196667, 49220, 153350, 312171, 119515, 186124, 160630, 153839, 48782, 97148, 226114, 123552, 517225}, {226641, 401805, 69215, 266603, 352088, 517295, 68157, 507392, 44078, 171919, 190032, 51172, 236790, 225813, 295260, 250454, 66129, 143751, 3507, 123480, 219634, 506787, 431503, 243408, 54551, 315712, 360506, 34401, 331318, 388939, 521051, 210625}, {110132, 173805, 460198, 117603, 64365, 16305, 463445, 439112, 280301, 522349, 333483, 182201, 288275, 67017, 318680, 79823, 254210, 358194, 512389, 280197, 79914, 488711, 310117, 174893, 236846, 120011, 140823, 101917, 374158, 248378, 11161, 427356}, {30536, 230916, 156093, 499484, 256482, 449794, 2761, 356833, 299016, 236725, 475828, 283662, 161834, 195556, 506940, 411331, 158821, 303136, 178983, 444864, 160759, 391939, 21256, 309296, 53920, 150524, 363475, 292908, 519227, 417140, 255881, 405685}, {126172, 73244, 56922, 25611, 315328, 491833, 213119, 472609, 153962, 432820, 329511, 250115, 512819, 177617, 128963, 377602, 446628, 339775, 431867, 121969, 196830, 337268, 475817, 457924, 67700, 39943, 320537, 92384, 498164, 293096, 230900, 44656}, {425334, 117833, 471821, 180749, 455048, 400886, 318837, 61446, 379321, 197889, 501529, 24990, 125215, 465026, 442178, 25221, 78114, 479817, 336447, 277613, 177887, 280129, 189075, 354430, 461678, 138086, 474348, 327799, 433509, 326927, 234044, 50011}, {177112, 378217, 97600, 43881, 474424, 256999, 103109, 392507, 173653, 150652, 325116, 254419, 337880, 271991, 115753, 264047, 160382, 441281, 95498, 487151, 482419, 148314, 42798, 292250, 76811, 158687, 92585, 480536, 349751, 226540, 257629, 114032}, {459004, 323621, 371254, 54995, 218181, 427199, 279202, 451346, 433496, 367184, 16792, 450685, 164675, 301495, 222082, 326159, 66704, 359669, 486475, 408223, 45197, 110778, 314104, 320258, 297089, 54403, 257287, 322774, 339723, 438283, 64750, 372177}, {99864, 442094, 516365, 145765, 169376, 64832, 371288, 133256, 102293, 10738, 343060, 432484, 458559, 359892, 446448, 74460, 502889, 57339, 332750, 336269, 423068, 453221, 456844, 93768, 153280, 498603, 189207, 112554, 337790, 89221, 445216, 369354}, {122523, 264705, 60606, 98470, 75700, 458545, 396368, 421956, 514713, 238368, 321005, 323384, 342437, 248298, 146352, 345207, 413272, 16820, 397368, 318261, 30341, 11882, 62623, 429479, 470643, 352506, 518982, 395643, 24100, 303353, 408253, 254418}, {453166, 190820, 435737, 35973, 328292, 123751, 55817, 29335, 434861, 422884, 292858, 157074, 62537, 260767, 66203, 275885, 309216, 388045, 67847, 446074, 39596, 505568, 477182, 272901, 283392, 30558, 397912, 365592, 432784, 308883, 273449, 8586}, {431796, 298728, 417226, 518493, 325904, 510911, 155167, 30589, 138450, 273039, 413040, 137976, 302838, 240675, 513057, 7026, 485827, 126650, 463509, 232364, 452075, 513003, 256400, 88307, 195973, 278288, 506988, 24890, 448329, 492295, 174180, 377789}, {502347, 335910, 83544, 150000, 115855, 310560, 484935, 241818, 383172, 511935, 314841, 508631, 57716, 341040, 187727, 369382, 418299, 457658, 333843, 214660, 493463, 67000, 190553, 136875, 108249, 32657, 429820, 380037, 248788, 340630, 264966, 266078}, {363849, 364675, 187939, 131437, 68916, 375165, 453968, 447294, 461560, 16475, 481053, 499592, 402820, 343050, 389833, 80724, 386492, 81623, 476560, 20517, 189312, 136827, 71028, 458769, 217489, 180652, 350939, 97669, 161455, 184839, 11329, 27277}, {398400, 490284, 88419, 32109, 160972, 383440, 378147, 184929, 54943, 427923, 75643, 31822, 8416, 154239, 441039, 413742, 84852, 473316, 422385, 233755, 498672, 144503, 306712, 462004, 54265, 108919, 263734, 156083, 173906, 452781, 232161, 169106}, {84475, 195867, 3117, 507888, 434333, 354335, 278723, 235688, 169889, 407777, 149389, 501588, 220990, 437734, 55100, 33555, 509131, 301438, 493815, 197470, 433066, 330741, 1427, 215242, 270870, 151634, 358037, 239216, 100398, 4711, 30286, 188383}, {211327, 429842, 250990, 383330, 17255, 194937, 384589, 49758, 11427, 510476, 160841, 453554, 314444, 226851, 266114, 452041, 207012, 465164, 324925, 142414, 73707, 57674, 405329, 298806, 366507, 499431, 490201, 504582, 403633, 367002, 145544, 158738}, {505867, 57244, 99311, 156314, 468836, 428024, 192760, 22396, 278785, 322848, 395516, 297830, 212404, 437921, 293551, 78914, 48410, 348864, 133689, 300725, 49770, 436949, 108758, 213893, 213554, 239401, 308541, 336555, 1855, 135479, 147498, 352241}, {12057, 306448, 412240, 390871, 342090, 429248, 281365, 230817, 300757, 453240, 321871, 342365, 195864, 174165, 305514, 462491, 262532, 499348, 28216, 150730, 99162, 273149, 328639, 68588, 142047, 196182, 34135, 376448, 498488, 519866, 477799, 467821}, {222811, 434063, 139023, 241091, 363847, 465406, 59407, 350746, 20719, 457397, 224067, 4969, 217622, 500672, 118773, 78616, 227442, 191311, 492643, 414250, 381797, 2614, 364484, 297804, 106656, 136951, 324118, 489356, 57079, 9256, 429327, 39327}, {478655, 336641, 273280, 300401, 357122, 193769, 366188, 228315, 15579, 41157, 344374, 302154, 396355, 486124, 127020, 309289, 487853, 366719, 382654, 466399, 302513, 520443, 1208, 465710, 33312, 301788, 168898, 483524, 514511, 178703, 450698, 23245}, {313196, 147741, 79060, 339041, 488863, 438211, 434634, 58756, 72926, 394206, 156637, 177576, 68914, 191341, 263044, 18024, 185404, 413821, 294949, 70747, 86494, 41428, 470150, 296391, 296896, 443681, 163328, 436484, 469519, 92553, 387547, 323174}, {356803, 490335, 263700, 318329, 27321, 377815, 228578, 171869, 520698, 412033, 392265, 301588, 119404, 118880, 140556, 217752, 387162, 320109, 300623, 196988, 388612, 4945, 298293, 311285, 232861, 48172, 141772, 103700, 36605, 276024, 476318, 66818}, {225631, 238864, 514596, 487436, 424808, 109435, 289672, 424282, 17894, 388984, 478692, 186125, 196471, 269422, 375663, 481192, 205185, 334908, 431053, 299656, 460983, 100876, 201445, 500544, 449933, 256941, 89983, 31142, 488157, 2121, 371977, 111203}, {211733, 179522, 312770, 38357, 142907, 195598, 142504, 247063, 292119, 75225, 303218, 149239, 255954, 377801, 369391, 200878, 387171, 238753, 246281, 446512, 121605, 242346, 244175, 174042, 31010, 155294, 139465, 177493, 357610, 476788, 403950, 436086}, {482805, 510162, 401798, 86266, 94526, 294906, 500809, 397277, 522426, 10498, 10770, 264995, 137462, 280108, 415595, 504556, 222444, 316701, 107337, 432270, 281205, 48089, 276552, 40607, 156582, 6466, 168629, 240293, 62297, 290810, 341686, 289874}, {413000, 44134, 193505, 489483, 304115, 20658, 361869, 122011, 241848, 367516, 457020, 493004, 320598, 411870, 269913, 10190, 346177, 365564, 482474, 71977, 455432, 28753, 501949, 224021, 519197, 422695, 59305, 113159, 365916, 439973, 388455, 39479}, {141969, 263789, 23327, 470531, 368987, 454835, 523438, 220654, 273841, 450714, 122562, 414742, 190813, 340143, 471244, 149225, 431812, 405075, 335910, 149741, 78138, 282838, 78775, 507245, 63303, 94500, 84324, 474068, 447771, 39114, 209055, 5520}, {167821, 67875, 391014, 416835, 51693, 25990, 416002, 471065, 129793, 423224, 22481, 149519, 106357, 48121, 124271, 135165, 160271, 471553, 366224, 352822, 470017, 372275, 47577, 183424, 477596, 466780, 377600, 358991, 297403, 31560, 185750, 477170}, {22579, 87179, 283830, 142492, 3484, 479676, 308983, 332557, 256191, 19197, 358382, 352943, 450557, 302238, 55943, 451828, 320245, 18351, 84372, 482500, 122571, 377664, 97757, 135123, 381262, 60218, 10991, 109478, 94553, 213897, 183838, 285211}, {224436, 315508, 349416, 426819, 521683, 397040, 502295, 304226, 218554, 8633, 447226, 249306, 290896, 4623, 335859, 181217, 369540, 68817, 265658, 223174, 74626, 511708, 183961, 326035, 127051, 458100, 396543, 257008, 244494, 61823, 21158, 224756}, {166780, 493174, 432561, 489693, 438139, 378823, 124677, 268636, 162170, 123272, 354096, 513627, 363459, 492354, 24879, 229634, 321798, 257443, 289889, 91089, 507017, 339443, 176383, 45210, 443961, 365577, 431191, 14125, 495851, 211368, 68658, 317583}, {332591, 97267, 388766, 316531, 333042, 496113, 257406, 63719, 306757, 259279, 34596, 517608, 421285, 6329, 200524, 393406, 142843, 196397, 331206, 416999, 89791, 226679, 166424, 379496, 162424, 285764, 161145, 90955, 238077, 401161, 409188, 351273}, {445614, 35863, 504599, 492924, 112659, 493608, 373336, 185755, 47896, 238139, 181187, 425251, 383807, 349825, 297721, 225704, 326689, 448833, 8956, 459891, 179065, 298089, 379144, 1321, 362020, 511160, 383040, 399901, 502856, 167221, 127350, 25128}, {374032, 279001, 476253, 73176, 388147, 123951, 149893, 1976, 335274, 222918, 54871, 273813, 44500, 46640, 347773, 34425, 505453, 487545, 315378, 273226, 232075, 50641, 168205, 437, 261649, 294723, 279009, 512867, 329422, 193094, 400444, 275742}, {116650, 242168, 92045, 347088, 315425, 137428, 364559, 288555, 414829, 217010, 166529, 234418, 482465, 213221, 202682, 438298, 287503, 454714, 431473, 80810, 169022, 195264, 287614, 458124, 56525, 297740, 425708, 249544, 76680, 121057, 380454, 15044}, {444424, 349439, 45981, 349210, 284708, 257005, 251421, 132487, 469133, 218253, 370750, 479450, 362205, 76106, 463403, 481175, 226675, 431285, 441117, 308028, 244569, 435284, 51663, 298198, 216226, 450181, 167241, 396765, 147818, 164406, 22844, 339456}, {3058, 57667, 260955, 363473, 22527, 430173, 231660, 256013, 194543, 504108, 187876, 132436, 228793, 484756, 393445, 71725, 301115, 361697, 506225, 171283, 1820, 521651, 393100, 414825, 389521, 39275, 362044, 413216, 370274, 229372, 424991, 481504}};
    private final static String SWF_URL = "http://www.radio.uol.com.br/widgets/swf/mediaPlayer.swf";
    private final static SwfVerificationHelper helper = new SwfVerificationHelper(SWF_URL);

    @Override
    public void runCheck() throws Exception {
        super.runCheck();
        final String mediaId = getMediaIdFromUrl();
        final HttpMethod method = getMediaInfoMethod(mediaId);
        if (makeRedirectedRequest(method)) {
            checkProblems();
            checkNameAndSize();
        } else {
            checkProblems();
            throw new ServiceConnectionProblemException();
        }
    }

    private void checkNameAndSize() throws ErrorDuringDownloadingException {
        final String fileName;
        final String title;
        String artistName = "";
        Matcher matcher = getMatcherAgainstContent("\"title\"\\s*:\\s*\"(.*?)\"");
        if (!matcher.find()) {
            throw new PluginImplementationException("Song title not found");
        }
        title = matcher.group(1).trim();
        if (title.isEmpty()) {
            throw new URLNotAvailableAnymoreException("Music not found");
        }

        matcher = getMatcherAgainstContent("artistName\"\\s*:\\s*\"(.*?)\"");
        if (matcher.find()) {
            artistName = matcher.group(1).trim() + " - ";
        }
        fileName = String.format("%s%s%s", artistName, title, isRtmp() ? ".flv" : ".mp3");
        httpFile.setFileName(fileName);
        httpFile.setFileState(FileState.CHECKED_AND_EXISTING);
    }

    @Override
    public void run() throws Exception {
        super.run();
        logger.info("Starting download in TASK " + fileURL);
        final String mediaId = getMediaIdFromUrl();
        HttpMethod method = getMediaInfoMethod(mediaId);
        if (makeRedirectedRequest(method)) {
            checkProblems();
            checkNameAndSize();
            if (!isRtmp()) {
                method = getMethodBuilder()
                        .setReferer(fileURL)
                        .setAction(String.format("http://storage.mais.uol.com.br/%s.mp3", mediaId))
                        .toHttpMethod();
                if (!tryDownloadAndSaveFile(method)) {
                    checkProblems();
                    throw new ServiceConnectionProblemException("Error starting download");
                }
            } else {
                method = getMethodBuilder()
                        .setReferer(fileURL)
                        .setAction(String.format("http://www.radio.uol.com.br/search/tracks/musicids/%s.ws", mediaId))
                        .toGetMethod();
                if (!makeRedirectedRequest(method)) {
                    checkProblems();
                    throw new ServiceConnectionProblemException();
                }
                checkProblems();
                Matcher matcher = getMatcherAgainstContent("url\\s*=\\s*\"(\\d+)\"");
                if (!matcher.find()) {
                    throw new PluginImplementationException("Url id not found");
                }
                final String urlId = matcher.group(1).trim();

                matcher = getMatcherAgainstContent("hash>(\\d+)</");
                if (!matcher.find()) {
                    throw new PluginImplementationException("App id not found");
                }
                final String app = matcher.group(1);
                final String host = "mm.radio.uol.com.br";
                final String play = String.format("mp4:%s_96.mp4", mediaHash(urlId));  //96 = HiRes, 28 = LowRes
                final RtmpSession rtmpSession = new RtmpSession(host, 1935, app, play, true);
                rtmpSession.getConnectParams().put("pageUrl", fileURL);
                rtmpSession.getConnectParams().put("swfUrl", SWF_URL);
                helper.setSwfVerification(rtmpSession, client);
                tryDownloadAndSaveFile(rtmpSession);
            }
        } else {
            checkProblems();
            throw new ServiceConnectionProblemException();
        }
    }

    private HttpMethod getMediaInfoMethod(final String mediaId) throws BuildMethodException {
        if (!isRtmp()) {
            return getMethodBuilder()
                    .setReferer(fileURL)
                    .setAction("http://mais.uol.com.br/apiuol/player/media.js")
                    .setParameter("mediaId", mediaId)
                    .setParameter("p", "mais")
                    .setParameter("action", "showPlayer")
                    .setParameter("types", "P")
                    .setParameter("callback", "setVideoInfo")
                    .toGetMethod();
        } else {
            return getMethodBuilder()
                    .setReferer(fileURL)
                    .setAction(String.format("http://www.radio.uol.com.br/letras-e-musicas/artista/titulo/%s.js", mediaId))
                    .toGetMethod();
        }
    }

    private String getMediaIdFromUrl() {
        return fileURL.substring(fileURL.lastIndexOf("/") + 1);
    }

    private boolean isRtmp() {
        return !fileURL.contains("/programa/");
    }

    private void checkProblems() throws ErrorDuringDownloadingException {
        final String contentAsString = getContentAsString();
        if (contentAsString.contains("Music not found")) {
            throw new URLNotAvailableAnymoreException("Music not found");
        }
    }

    private static int hash(final String str) {
        int out = 0;
        for (int i = 0; i < str.length(); i++) {
            out = (out + vHash[str.charAt(i)][i & MAX_RANDOM_TAB]) % MAX_HASH;
        }
        return out;
    }

    private static String mediaHash(final String str) {
        final int iHash = hash(str);
        return String.format("%x/%02x/%02x/%s", iHash & 0x0f, iHash >> 4 & 0x7f, iHash >> 11 & 0xff, str);
    }

}